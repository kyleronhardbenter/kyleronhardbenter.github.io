<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divisas - GestiÃ³n de Gastos e Ingresos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1><i class="fas fa-wallet"></i> Finanzas</h1>
        </div>
        <ul class="nav-links">
            <li><a href="index.html" class="nav-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
            <li><a href="expenses.html" class="nav-link"><i class="fas fa-minus-circle"></i> Gastos</a></li>
            <li><a href="incomes.html" class="nav-link"><i class="fas fa-plus-circle"></i> Ingresos</a></li>
            <li><a href="currencies.html" class="nav-link active"><i class="fas fa-exchange-alt"></i> Divisas</a></li>
        </ul>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        <header class="page-header">
            <h1><i class="fas fa-exchange-alt"></i> ConversiÃ³n de Divisas</h1>
        </header>

        <!-- Current Balance Card -->
        <div class="card balance" style="margin-bottom: 2rem;">
            <h3><i class="fas fa-euro-sign"></i> Saldo Actual</h3>
            <p id="current-balance">â‚¬0.00</p>
        </div>

        <!-- Currency Converter -->
        <div class="form-container">
            <h2><i class="fas fa-star"></i> Divisas Favoritas</h2>
            <div id="favorites-list" class="currencies-grid">
                <!-- Favorites will be loaded here -->
            </div>
        </div>

        <div class="form-container">
            <h2><i class="fas fa-globe"></i> Todas las Divisas</h2>
            <div class="filters" style="margin-bottom: 1.5rem;">
                <input type="text" id="currency-search" placeholder="Buscar divisa...">
            </div>
            <div id="currencies-list" class="currencies-grid">
                <!-- All currencies will be loaded here -->
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Currency conversion functionality
        const CURRENCY_API_URL = 'https://api.exchangerate-api.com/v4/latest/EUR';
        let exchangeRates = {};
        let favorites = [];

        // Load favorites from localStorage
        function loadFavorites() {
            const stored = localStorage.getItem('currencyFavorites');
            favorites = stored ? JSON.parse(stored) : [];
        }

        // Save favorites to localStorage
        function saveFavorites() {
            localStorage.setItem('currencyFavorites', JSON.stringify(favorites));
        }

        // Fetch exchange rates
        async function fetchExchangeRates() {
            try {
                const response = await fetch(CURRENCY_API_URL);
                const data = await response.json();
                // Only include top currencies even from API
                const topCurrencies = ['EUR', 'USD', 'GBP', 'JPY', 'CAD', 'AUD', 'CHF', 'CNY', 'PHP', 'KRW', 'MXN'];
                exchangeRates = {};
                topCurrencies.forEach(currency => {
                    if (data.rates[currency]) {
                        exchangeRates[currency] = data.rates[currency];
                    }
                });
                return true;
            } catch (error) {
                console.error('Error fetching exchange rates:', error);
                // Fallback rates if API fails - current approximate rates (late 2024)
                exchangeRates = {
                    'EUR': 1.0,
                    'USD': 1.05,
                    'GBP': 0.83,
                    'JPY': 158.0,
                    'CAD': 1.42,
                    'AUD': 1.62,
                    'CHF': 0.92,
                    'CNY': 7.5,
                    'PHP': 58.0,
                    'KRW': 1380.0,
                    'MXN': 19.5
                };
                return false;
            }
        }

        // Get current balance
        function getCurrentBalance() {
            const data = loadData();
            const totalIncomes = data.incomes.reduce((sum, i) => sum + i.amount, 0);
            const totalExpenses = data.expenses.reduce((sum, e) => sum + e.amount, 0);
            return totalIncomes - totalExpenses;
        }

        // Display currencies
        function displayCurrencies() {
            const balance = getCurrentBalance();
            document.getElementById('current-balance').textContent = `â‚¬${balance.toFixed(2)}`;

            const favoritesList = document.getElementById('favorites-list');
            const currenciesList = document.getElementById('currencies-list');
            const searchTerm = document.getElementById('currency-search').value.toLowerCase();

            favoritesList.innerHTML = '';
            currenciesList.innerHTML = '';

            const currencyNames = {
                'EUR': 'ğŸ‡ªğŸ‡¸ Euro',
                'USD': 'ğŸ‡ºğŸ‡¸ DÃ³lar estadounidense',
                'GBP': 'ğŸ‡¬ğŸ‡§ Libra esterlina',
                'JPY': 'ğŸ‡¯ğŸ‡µ Yen japonÃ©s',
                'CAD': 'ğŸ‡¨ğŸ‡¦ DÃ³lar canadiense',
                'AUD': 'ğŸ‡¦ğŸ‡º DÃ³lar australiano',
                'CHF': 'ğŸ‡¨ğŸ‡­ Franco suizo',
                'CNY': 'ğŸ‡¨ğŸ‡³ Yuan chino',
                'PHP': 'ğŸ‡µğŸ‡­ Peso filipino',
                'KRW': 'ğŸ‡°ğŸ‡· Won surcoreano',
                'MXN': 'ğŸ‡²ğŸ‡½ Peso mexicano',
                'SEK': 'ğŸ‡¸ğŸ‡ª Corona sueca',
                'NOK': 'ğŸ‡³ğŸ‡´ Corona noruega',
                'DKK': 'ğŸ‡©ğŸ‡° Corona danesa',
                'PLN': 'ğŸ‡µğŸ‡± ZÅ‚oty polaco',
                'CZK': 'ğŸ‡¨ğŸ‡¿ Corona checa',
                'HUF': 'ğŸ‡­ğŸ‡º Forinto hÃºngaro',
                'RON': 'ğŸ‡·ğŸ‡´ Leu rumano',
                'BGN': 'ğŸ‡§ğŸ‡¬ Lev bÃºlgaro',
                'HRK': 'ğŸ‡­ğŸ‡· Kuna croata',
                'TRY': 'ğŸ‡¹ğŸ‡· Lira turca',
                'RUB': 'ğŸ‡·ğŸ‡º Rublo ruso',
                'BRL': 'ğŸ‡§ğŸ‡· Real brasileÃ±o',
                'ARS': 'ğŸ‡¦ğŸ‡· Peso argentino',
                'CLP': 'ğŸ‡¨ğŸ‡± Peso chileno',
                'COP': 'ğŸ‡¨ğŸ‡´ Peso colombiano',
                'PEN': 'ğŸ‡µğŸ‡ª Sol peruano'
            };

            // Display favorites first
            favorites.forEach(currency => {
                if (exchangeRates[currency]) {
                    const convertedAmount = balance * exchangeRates[currency];
                    const currencyCard = createCurrencyCard(currency, currencyNames[currency] || currency, convertedAmount, true);
                    favoritesList.appendChild(currencyCard);
                }
            });

            // Display all currencies (excluding favorites)
            Object.keys(exchangeRates).forEach(currency => {
                if (!favorites.includes(currency) && (searchTerm === '' || currency.toLowerCase().includes(searchTerm) || (currencyNames[currency] && currencyNames[currency].toLowerCase().includes(searchTerm)))) {
                    const convertedAmount = balance * exchangeRates[currency];
                    const currencyCard = createCurrencyCard(currency, currencyNames[currency] || currency, convertedAmount, false);
                    currenciesList.appendChild(currencyCard);
                }
            });
        }

        // Create currency card
        function createCurrencyCard(currency, name, amount, isFavorite) {
            // Remove flag emoji from name if it exists
            const cleanName = name.replace(/ğŸ‡ªğŸ‡¸|ğŸ‡ºğŸ‡¸|ğŸ‡¬ğŸ‡§|ğŸ‡¯ğŸ‡µ|ğŸ‡¨ğŸ‡¦|ğŸ‡¦ğŸ‡º|ğŸ‡¨ğŸ‡­|ğŸ‡¨ğŸ‡³|ğŸ‡µğŸ‡­|ğŸ‡°ğŸ‡·|ğŸ‡²ğŸ‡½|ğŸ³ï¸/g, '').trim();

            // Get flag class for styling
            const flagClasses = {
                'EUR': 'flag-es',
                'USD': 'flag-us',
                'GBP': 'flag-gb',
                'JPY': 'flag-jp',
                'CAD': 'flag-ca',
                'AUD': 'flag-au',
                'CHF': 'flag-ch',
                'CNY': 'flag-cn',
                'PHP': 'flag-ph',
                'KRW': 'flag-kr',
                'MXN': 'flag-mx'
            };
            const flagClass = flagClasses[currency] || 'flag-default';

            const card = document.createElement('div');
            card.className = 'currency-card';
            card.innerHTML = `
                <div class="currency-header">
                    <div class="currency-info">
                        <div class="currency-code-row">
                            <span class="currency-flag ${flagClass}"></span>
                            <strong>${currency}</strong>
                        </div>
                        <span>${cleanName}</span>
                    </div>
                    <button class="btn-icon btn-favorite ${isFavorite ? 'active' : ''}" data-currency="${currency}">
                        <i class="fas fa-star"></i>
                    </button>
                </div>
                <div class="currency-amount">
                    ${amount.toFixed(2)} ${currency}
                </div>
            `;

            // Add event listener for favorite button
            const favoriteBtn = card.querySelector('.btn-favorite');
            favoriteBtn.addEventListener('click', function() {
                const curr = this.getAttribute('data-currency');
                if (favorites.includes(curr)) {
                    favorites = favorites.filter(f => f !== curr);
                    this.classList.remove('active');
                } else {
                    favorites.push(curr);
                    this.classList.add('active');
                }
                saveFavorites();
                displayCurrencies();
            });

            return card;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            loadFavorites();
            const apiSuccess = await fetchExchangeRates();
            displayCurrencies();

            // Add search functionality
            document.getElementById('currency-search').addEventListener('input', displayCurrencies);

            // Update balance when data changes
            updateDashboard();
        });
    </script>
</body>
</html>
